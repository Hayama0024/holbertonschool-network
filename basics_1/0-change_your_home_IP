#!/usr/bin/env bash
# Set /etc/hosts so that: localhost -> 127.0.0.2 and facebook.com -> 8.8.8.8 (silent & idempotent)

set -euo pipefail

hosts="/etc/hosts"
tmp="$(mktemp)"
tmp2="$(mktemp)"

# 1) 望む2行を先頭に書く（優先解決のため）
{
  printf '127.0.0.2 localhost\n'
  printf '8.8.8.8 facebook.com\n'
  # 2) 既存hostsを整形:
  #    - facebook.com を含む行は除去（上で固定するため）
  #    - 127.0.0.1 の行から localhost 系だけ除外（127.0.0.2 を優先させるため）
  #    - コメント/空行はそのまま
  awk '
    /^[[:space:]]*#/ || /^[[:space:]]*$/ { print; next }

    {
      # facebook.com を消す
      for (i=1; i<=NF; i++) if ($i=="facebook.com") $i=""
      # フィールド詰め直し
      line=""
      for (i=1; i<=NF; i++) if ($i!="") line = (line ? line FS $i : $i)
      if (line=="") next
      $0=line
    }

    $1=="127.0.0.1" {
      out=$1; kept=0
      for (i=2; i<=NF; i++) {
        if ($i!="localhost" && $i!="localhost.localdomain") {
          out = out FS $i
          kept=1
        }
      }
      if (kept) print out
      next
    }

    { print }
  ' "$hosts"
} > "$tmp"

# 3) 先頭勝ちのまま重複行を除去（順序保持）
awk '!seen[$0]++' "$tmp" > "$tmp2"

# 4) 置換（権限は /etc/hosts のものが維持される）
cat "$tmp2" > "$hosts"

rm -f "$tmp" "$tmp2"

